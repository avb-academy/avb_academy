{{ $slug := .Page.File.Path | replaceRE "^/" "" | replaceRE "/$" "" }}

{{ $safeSlug := "" }}

{{ if or (eq $slug "") (eq $slug "_index.md") }}
  {{ $safeSlug = "root" }}
{{ else }}
  {{ $safeSlug = $slug | replaceRE "-" "_" | replaceRE "\\." "_" }}
{{ end }}

{{ $parts := split $safeSlug "/" }}

{{ $commentsFolder := site.Data.comments }}
{{ range $parts }}
  {{ $commentsFolder = index $commentsFolder . }}
{{ end }}

{{ if $commentsFolder }}
  {{ $.Scratch.Set "comments" (slice) }}
  {{ range $key, $comment := $commentsFolder }}
    {{ $.Scratch.Add "comments" (slice $comment) }}
  {{ end }}
  {{ $comments := $.Scratch.Get "comments" }}
  {{ $sorted := sort $comments "date" "desc" }}

  <div class="comments-container">
    <h2>Comments</h2>
    {{ range $comment := $sorted }}
      <div class="comment">
        <strong>{{ $comment.name }}</strong><br>
        <small>{{ $comment.date }}</small>
        <p>{{ $comment.message }}</p>
      </div>
    {{ end }}
  </div>
{{ else }}
  <p>No comments yet.</p>
{{ end }}
