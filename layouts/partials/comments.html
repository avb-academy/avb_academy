{{/* layouts/partials/comments.html — safe for Hugo v0.148 */}}

{{ $commentsFolder := site.Data.comments }}
{{ $filePath := "" }}
{{ $safeSlug := "" }}

{{ if .File }}
    {{ $filePath = .File.Path }}
    {{ $safeSlug = $filePath | replaceRE "^/" "" | replaceRE "/$" "" }}
    {{ $safeSlug = replace $safeSlug "_index.en.md" "_index_en_md" }}
    {{ $safeSlug = replace $safeSlug "_index.de.md" "_index_de_md" }}
    {{ $safeSlug = replace $safeSlug "_index.md" "_index_md" }}

    {{ $parts := split $safeSlug "/" }}

    {{/* Safely traverse comments tree */}}
    {{ range $parts }}
        {{ if and $commentsFolder (isset $commentsFolder .) }}
            {{ $commentsFolder = index $commentsFolder . }}
        {{ else }}
            {{ $commentsFolder = dict }} {{/* Never let it be nil */}}
        {{ end }}
    {{ end }}
{{ else }}
    {{ $commentsFolder = dict }}
{{ end }}

{{/* Debug info */}}
<div style="border:1px solid #ccc; padding:0.5rem; margin:0.5rem 0;">
    <strong>Debug Info:</strong>
    <ul>
        <li>Lang: {{ .Lang }}</li>
        <li>File Path: {{ $filePath }}</li>
        <li>Safe Slug: {{ $safeSlug }}</li>
        <li>Comments Found: {{ if $commentsFolder }}✅ yes{{ else }}❌ no{{ end }}</li>
    </ul>
</div>

{{/* Render comments if present */}}
{{ if gt (len $commentsFolder) 0 }}
    {{ range $key, $comment := $commentsFolder }}
        <div class="comment">
            <strong>{{ $comment.name }}</strong>
            <small>({{ time $comment.date | dateFormat "2006-01-02 15:04:05" }})</small>
            <p>{{ $comment.message }}</p>
        </div>
    {{ end }}
{{ else }}
    <p>No comments yet.</p>
{{ end }}
