{{- /* ------------------------------------------ */ -}}
{{- /* Comments Partial – Fully Nested + Multilingual + Legacy */ -}}
{{- /* Hugo 0.148+ safe, no variable reassignment errors */ -}}
{{- /* ------------------------------------------ */ -}}

{{- /* Initialize variables safely */ -}}
{{- $filePath := "" -}}
{{- $rawFolder := "." -}}
{{- with .File -}}
    {{- $filePath = .Path -}}
    {{- $rawFolder = path.Dir .Path -}}
{{- end -}}
{{- $lang := .Lang -}}
{{- $allComments := slice -}}

{{- /* Split folder path into segments and normalize hyphens */ -}}
{{- $folderSegments := slice -}}
{{- if ne $rawFolder "." -}}
    {{- $folderSegments = split $rawFolder "/" -}}
    {{- $folderSegments = apply $folderSegments "replaceRE" `-` "_" "." -}}
{{- end -}}

{{- /* Traverse nested comment data safely */ -}}
{{- $nested := site.Data.comments -}}
{{- range $i, $seg := $folderSegments -}}
    {{- $next := index $nested $seg | default dict -}}
    {{- $nested = $next -}}
{{- end -}}

{{- /* Language-specific comments */ -}}
{{- $langFile := printf "_index_%s_md" $lang -}}
{{- with index $nested $langFile -}}
    {{- $allComments = $allComments | append . -}}
{{- end -}}

{{- /* Legacy comments (English only) */ -}}
{{- if eq $lang "en" -}}
    {{- $legacyFile := "_index_md" -}}
    {{- with index $nested $legacyFile -}}
        {{- $allComments = $allComments | append . -}}
    {{- end -}}
{{- end -}}

{{- /* Flatten nested comment lists */ -}}
{{- $flatComments := slice -}}
{{- range $allComments -}}
    {{- range . -}}
        {{- $flatComments = $flatComments | append . -}}
    {{- end -}}
{{- end -}}

{{- /* Sort comments by date descending */ -}}
{{- $sortedComments := sort $flatComments "date" "desc" -}}

{{- /* ------------------- Debug Info ------------------- */ -}}
<div class="debug-comments">
<strong>Debug Info:</strong><br>
Lang: {{ $lang }}<br>
File Path: {{ if $filePath }}{{ $filePath }}{{ else }}(no file){{ end }}<br>
Folder Segments: {{ if $folderSegments }}{{ delimit $folderSegments "/" }}{{ else }}(root){{ end }}<br>
Lang File: {{ $langFile }}<br>
Legacy File: _index_md<br>
Comments Found: {{ if gt (len $sortedComments) 0 }}✅ yes{{ else }}❌ no{{ end }}
</div>

{{- /* ------------------- Render Comments ------------------- */ -}}
{{- if gt (len $sortedComments) 0 -}}
<div class="comments-container">
    <h2>Comments</h2>
    {{- range $comment := $sortedComments -}}
        <div class="comment">
            <strong>{{ $comment.name }}</strong><br>
            {{- $date := time $comment.date -}}
            <small>{{ $date.Format "2006-01-02 15:04:05" }}</small>
            <p>{{ $comment.message | safeHTML }}</p>
        </div>
    {{- end -}}
</div>
{{- else -}}
<p>No comments yet.</p>
{{- end -}}
