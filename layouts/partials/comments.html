{{- /* ----------------------------- */ -}}
{{- /* Comments Partial - Working Version */ -}}
{{- /* ----------------------------- */ -}}

{{- $filePath := .File.Path -}}

{{- /* Safely get base filename */ -}}
{{- $baseName := .File.BaseFileName -}}
{{- if not $baseName -}}
    {{- $splitPath := split $filePath "/" -}}
    {{- $baseName = index (last 1 $splitPath) 0 -}}
{{- end -}}

{{- /* Generate safeSlug and genericSlug */ -}}
{{- $safeSlug := replace $baseName "." "_" -}}
{{- $genericSlug := $safeSlug -}}
{{- if or (hasSuffix $genericSlug "_en") (hasSuffix $genericSlug "_de") -}}
    {{- $genericSlug = substr $genericSlug 0 (sub (len $genericSlug) 3) -}}
{{- end -}}

{{- $lang := .Lang -}}
{{- $allComments := slice -}}

{{- /* Language-specific comments */ -}}
{{- $langKey := printf "%s_%s_md" $genericSlug $lang -}}
{{- with index site.Data.comments $langKey -}}
    {{- $allComments = $allComments | append . -}}
{{- end -}}

{{- /* Generic fallback comments */ -}}
{{- $fallbackKeys := slice $genericSlug -}}
{{- if eq $lang "en" -}}
    {{- $fallbackKeys = $fallbackKeys | append (printf "%s_md" $genericSlug) -}}
{{- end -}}

{{- range $fallbackKeys -}}
    {{- with index site.Data.comments . -}}
        {{- $allComments = $allComments | append . -}}
    {{- end -}}
{{- end -}}

{{- /* Flatten nested comments */ -}}
{{- $flatComments := slice -}}
{{- range $allComments -}}
    {{- range . -}}
        {{- $flatComments = $flatComments | append . -}}
    {{- end -}}
{{- end -}}

<div class="debug-comments">
<strong>Debug Info:</strong><br>
Lang: {{ $lang }}<br>
File Path: {{ $filePath }}<br>
Safe Slug: {{ $safeSlug }}<br>
Generic Slug: {{ $genericSlug }}<br>
Comments Found: {{ if gt (len $flatComments) 0 }}✅ yes{{ else }}❌ no{{ end }}
</div>

{{- if gt (len $flatComments) 0 -}}
<div class="comments-list">
    {{- range $flatComments -}}
        <div class="comment">
            <div class="comment-author">{{ .name }}</div>
            <div class="comment-date">{{ .date }}</div>
            <div class="comment-content">{{ .message | safeHTML }}</div>
        </div>
    {{- end -}}
</div>
{{- else -}}
<div class="no-comments">No comments yet.</div>
{{- end -}}
