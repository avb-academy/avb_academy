{{- /* ------------------------------------------ */ -}}
{{- /* Comments Partial – Multilingual + Legacy */ -}}
{{- /* Always load both: _xx_md and _en_md/_de_md */ -}}
{{- /* ------------------------------------------ */ -}}

{{- $filePath := .File.Path -}}
{{- $safeSlug := $filePath | replaceRE "[/.-]" "_" -}}

{{- /* Strip language suffix (_en_md, _de_md) for generic key */ -}}
{{- $genericSlug := $safeSlug -}}
{{- if or (hasSuffix $genericSlug "_en_md") (hasSuffix $genericSlug "_de_md") -}}
    {{- $genericSlug = substr $genericSlug 0 (sub (len $genericSlug) 6) -}}
{{- end -}}

{{- $lang := .Lang -}}
{{- $allComments := slice -}}

{{- /* 1. Language-specific comments, e.g. _index_en_md */ -}}
{{- $langKey := printf "%s_%s_md" $genericSlug $lang -}}
{{- with index site.Data.comments $langKey -}}
    {{- $allComments = $allComments | append . -}}
{{- end -}}

{{- /* 2. Legacy/base comments, only for English pages */ -}}
{{- $legacyKey := "" -}} {{/* declare variable first to make it global in this scope */}}

{{- if eq $lang "en" -}}
    {{- $legacyKey = printf "%s_md" $genericSlug -}}
    {{- with index site.Data.comments $legacyKey -}}
        {{- $allComments = $allComments | append . -}}
    {{- end -}}
{{- end -}}

{{- /* Flatten nested lists */ -}}
{{- $flatComments := slice -}}
{{- range $allComments -}}
    {{- range . -}}
        {{- $flatComments = $flatComments | append . -}}
    {{- end -}}
{{- end -}}

{{- /* Sort comments by date (descending) */ -}}
{{- $sortedComments := sort $flatComments "date" "desc" -}}

<div class="debug-comments">
<strong>Debug Info:</strong><br>
Lang: {{ $lang }}<br>
File Path: {{ $filePath }}<br>
Safe Slug: {{ $safeSlug }}<br>
Generic Slug: {{ $genericSlug }}<br>
Lang Key: {{ $langKey }}<br>
Legacy Key: {{ $legacyKey }}<br>
Comments Found: {{ if gt (len $sortedComments) 0 }}✅ yes{{ else }}❌ no{{ end }}
</div>

{{- if gt (len $sortedComments) 0 -}}
<div class="comments-container">
    <h2>Comments</h2>
    {{- range $comment := $sortedComments -}}
        <div class="comment">
            <strong>{{ $comment.name }}</strong><br>
            {{- $date := time $comment.date -}}
            <small>{{ $date.Format "2006-01-02 15:04:05" }}</small>
            <p>{{ $comment.message | safeHTML }}</p>
        </div>
    {{- end -}}
</div>
{{- else -}}
<p>No comments yet.</p>
{{- end -}}
