{{- /* layouts/shortcodes/termbase.html */ -}}
{{- $lang := .Site.Language.Lang -}}
{{- $input := .Get 0 -}}
{{- $normalized := $input -}}
{{- $translation := "" -}}
{{- $found := true -}}

{{/* --- CASE-INSENSITIVE LOOKUP --- */}}
{{- $keyLower := lower $input -}}
{{- $matchedKey := "" -}}
{{- range $k, $v := .Site.Data.termbase -}}
  {{- if eq (lower $k) $keyLower -}}
    {{- $matchedKey = $k -}}
  {{- end -}}
{{- end -}}

{{- if ne $matchedKey "" -}}
  {{- with index .Site.Data.termbase $matchedKey -}}
    {{- $translation = index . $lang | default $matchedKey -}}
  {{- else -}}
    {{- $translation = $matchedKey -}}
    {{- $found = false -}}
  {{- end -}}
{{- else -}}
  {{- $translation = $input -}}
  {{- $found = false -}}
{{- end -}}

{{/* --- DETECT CAPITALIZATION PATTERN --- */}}
{{- $isAllCaps := eq $input (upper $input) -}}
{{- $isLower := eq $input (lower $input) -}}
{{- $isTitleCase := eq $input (title $input) -}}

{{/* --- DETECT “mixed case” (e.g. traffic Shaping) --- */}}
{{- $wordsInput := split $input " " -}}
{{- $isMixedCase := and (not $isAllCaps) (not $isLower) (not $isTitleCase)
    (and (ge (len $wordsInput) 2)
         (and (eq (lower (index $wordsInput 0)) (index $wordsInput 0))
              (ne (title (index $wordsInput 1)) (lower (index $wordsInput 1))))) -}}

{{/* --- APPLY CAPITALIZATION BEHAVIOR --- */}}
{{- if $isAllCaps -}}
  {{- $translation = upper $translation -}}
{{- else if $isLower -}}
  {{- $translation = lower $translation -}}
{{- else if $isMixedCase -}}
  {{- $words := split $translation " " -}}
  {{- if gt (len $words) 1 -}}
    {{- $first := lower (index $words 0) -}}
    {{- $rest := delimit (after 1 $words) " " -}}
    {{- $translation = printf "%s %s" $first $rest -}}
  {{- else -}}
    {{- $translation = lower $translation -}}
  {{- end -}}
{{- else if (and (not $isAllCaps) (not $isLower) (not $isTitleCase)) -}}
  {{- $words := split $translation " " -}}
  {{- if gt (len $words) 1 -}}
    {{- $first := title (index $words 0) -}}
    {{- $rest := delimit (after 1 $words) " " -}}
    {{- $translation = printf "%s %s" $first (lower $rest) -}}
  {{- else -}}
    {{- $translation = title $translation -}}
  {{- end -}}
{{- else if $isTitleCase -}}
  {{- $translation = title $translation -}}
{{- else -}}
  {{- $translation = $translation -}}
{{- end -}}

{{/* --- RENDER OUTPUT --- */}}
{{- if not $found -}}
  {{- if site.Params.termbaseStrict -}}
    {{- errorf "Termbase lookup failed for '%s' in '%s'" $input .Page.Path -}}
  {{- else -}}
    {{- warnf "Termbase term not found: '%s' (%s)" $input .Page.Path -}}
  {{- end -}}
  <span style="color: red; font-weight: bold;">{{ $translation }}</span>
{{- else -}}
  {{ $translation | safeHTML -}}
{{- end -}}
