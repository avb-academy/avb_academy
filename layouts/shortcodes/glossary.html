{{ $lang := .Site.Language.Lang }}
{{ $glossary := site.Data.glossary }}

<input type="text" id="glossarySearch" placeholder="{{ i18n "search_placeholder" }}" onkeyup="filterGlossary()">

<div id="glossaryContainer">
  {{ range $term, $entry := $glossary }}
    {{- $termsToShow := slice $term -}}
    {{- if $entry.aliases -}}
      {{- range $i, $alias := $entry.aliases -}}
        {{- $termsToShow = append $termsToShow (slice $alias) -}}
      {{- end -}}
    {{- end -}}

    {{- range $t := $termsToShow -}}
      <div class="glossary-entry" id="{{ $t | urlize }}">
        <h2>{{ $t }}</h2>

        {{- $termLang := index $entry $lang -}}
        {{- if reflect.IsMap $termLang -}}
          {{- if $termLang.short -}}
            <p><strong>{{ i18n "short_definition" }}</strong> {{ $termLang.short }}</p>
          {{- end -}}
          <p><strong>{{ i18n "explanation" }}</strong> {{ $termLang.explanation | markdownify }}</p>
        {{- else -}}
          <p><strong>{{ i18n "short_definition" }}</strong> {{ $termLang | markdownify }}</p>
        {{- end -}}

        {{- if $entry.reference -}}
          <p><strong>{{ i18n "reference" }}</strong> {{ $entry.reference | safeHTML | markdownify }}</p>
        {{- end -}}

        {{- if $entry.see_also -}}
          <p><strong>{{ i18n "see_also" }}</strong>
            {{- range $i, $related := $entry.see_also -}}
              <a href="#{{ $related | urlize }}">{{ $related }}</a>{{ if lt (add $i 1) (len $entry.see_also) }}, {{ end }}
            {{- end -}}
          </p>
        {{- end -}}
      </div>
    {{- end -}}
  {{ end }}
</div>

<script>
function highlightTermByHash() {
    const hash = window.location.hash;
    if (!hash) return;

    const term = document.querySelector(hash);
    if (!term) return;

    term.scrollIntoView({ behavior: "smooth" });

    term.style.transition = "none";
    term.style.background = "#fdf6c9";
    term.style.color = "#000";

    // Force reflow to restart transition
    term.offsetHeight;

    setTimeout(() => {
        term.style.transition = "background 1.5s ease-out, color 1.5s ease-out";
        term.style.background = "transparent";
        term.style.color = "";
    }, 100);
}

document.addEventListener("DOMContentLoaded", highlightTermByHash);
window.addEventListener("hashchange", highlightTermByHash);

function filterGlossary() {
    let input = document.getElementById("glossarySearch").value.toLowerCase();
    let terms = document.querySelectorAll(".glossary-entry");

    terms.forEach(term => {
        let text = term.textContent.toLowerCase();
        term.style.display = text.includes(input) ? "block" : "none";
    });
}
</script>
